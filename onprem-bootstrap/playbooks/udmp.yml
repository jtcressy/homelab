---
- name: udmp setup
  gather_facts: false
  hosts: unifiudm
  vars:
    udm_onboot_version: 1.0.5
    udm_onboot_download_uri: "https://github.com/boostchicken/udm-utilities/releases/download/{{ udm_onboot_version }}/udm-boot_{{ udm_onboot_version }}_all.deb"

    unifi_mount_path: "/mnt/data"
    unifi_os_mount_path: "/data"

    unifi_os_container: "unifi-os"
    unifi_os_cmd: podman exec -it "{{ unifi_os_container }}"

    unifi_onboot_directory: "{{ unifi_mount_path }}/on_boot.d/"

  tasks:
  - name: onboot - query package version
    register: onboot_version
    raw: "{{ unifi_os_cmd }} dpkg-query --showformat='${Version}' --show udm-boot"

  - name: onboot - installation
    when: onboot_version is not defined or ( onboot_version.stdout is defined and onboot_version.stdout != udm_onboot_version )
    block:
      - name: onboot - download package
        raw: curl -L "{{ udm_onboot_download_uri }}" -o "{{ unifi_mount_path }}/unifi-os/udm-boot-{{ udm_onboot_version }}.deb"
      - name: onboot - install package
        raw: "{{ unifi_os_cmd }} dpkg -i {{ unifi_os_mount_path }}/udm-boot-{{ udm_onboot_version }}.deb"

  - name: onboot - ensure onboot directory exists
    raw: mkdir -p "{{ unifi_onboot_directory }}"

  - name: tailscale shell script
    # copy:
    #   scp_if_ssh: true
    #   dest: "/mnt/data/on-boot.d/11-tailscale.sh"
    #   content: |
    raw: |-
        cat <<EOF > {{ unifi_onboot_directory }}/11-tailscale.sh
        #!/bin/sh
        CONTAINER=tailscaled
        IMAGE=ghcr.io/tailscale/tailscale:v1.18.2
        # Starts a Tailscale container that is deleted after it is stopped.
        # All configs stored in /mnt/data/tailscale
        if podman container exists ${CONTAINER}; then
          podman start ${CONTAINER}
        else
          mkdir -p /mnt/data/tailscale
          podman run --rm --device=/dev/net/tun --net=host --cap-add=NET_ADMIN --cap-add=SYS_ADMIN --cap-add=CAP_SYS_RAWIO -v /mnt/data/tailscale:/var/lib/tailscale --name=${CONTAINER} -d --entrypoint /bin/sh ${IMAGE} -c "tailscaled --tun eth11"
        fi
        EOF
